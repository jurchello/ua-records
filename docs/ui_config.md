# UARecords — Конфігурація користувацького інтерфейсу (UI Config README)

Цей документ надає детальний опис усіх налаштувань конфігурації користувацького інтерфейсу UARecords, доступних через Gramps > Налаштування > Плагіни > UARecords.

## Структура налаштувань

Усі налаштування зберігаються в `~/.gramps/gramps60/UARecords/configs/config.ini` і керуються через клас `SettingsManager`.

---

## 1. Налаштування ШІ (AI Settings)

### Провайдер ШІ
- **Параметр**: `form.ai_provider`
- **Тип**: перелік
- **Значення за замовчуванням**: `"disabled"`
- **Можливі значення**:
  - `"disabled"` — Вимкнено
  - `"openai"` — OpenAI
  - `"mistral"` — Mistral  
  - `"gemini"` — Gemini
- **Ефект**: Визначає, який провайдер ШІ використовується для автоматичного заповнення та підказок у формах.

### Модель ШІ
- **Параметр**: `form.ai_model`
- **Тип**: рядок
- **Значення за замовчуванням**: `""` (порожній рядок)
- **Приклади**: `"gpt-4o-mini"`, `"mistral-7b"`, `"gemini-pro"`
- **Ефект**: Вказує конкретну модель провайдера ШІ для використання.

### API ключ
- **Параметр**: `form.ai_api_key`
- **Тип**: рядок
- **Значення за замовчуванням**: `""` (порожній рядок)
- **Ефект**: API ключ для автентифікації з провайдером ШІ. Зберігається в незашифрованому вигляді.
- **Безпека**: ⚠️ Ключ зберігається в конфіг-файлі без шифрування.

---

## 2. Налаштування колонок форм

### Колонки народження
- **Параметр**: `form.birth_columns`
- **Тип**: число
- **Значення за замовчуванням**: `3`
- **Діапазон**: 1–5
- **Ефект**: Визначає кількість пар "мітка+контрол" у фреймах форми народження. Впливає на:
  - Розкладку полів (`order`)
  - Видимість полів (`show_when_cols_in`)
  - Розтягування полів (`span_pairs`)

### Колонки смерті
- **Параметр**: `form.death_columns`
- **Тип**: число
- **Значення за замовчуванням**: `3`
- **Діапазон**: 1–5
- **Ефект**: Аналогічно до колонок народження, але для форм смерті.

### Колонки шлюбу
- **Параметр**: `form.marriage_columns`
- **Тип**: число
- **Значення за замовчуванням**: `3`
- **Діапазон**: 1–5
- **Ефект**: Аналогічно до колонок народження, але для форм шлюбу.

---

## 3. Налаштування стилю та щільності

### Стиль форм (density)
- **Параметр**: `form.density`
- **Тип**: перелік
- **Значення за замовчуванням**: `"normal"`
- **Можливі значення**:
  - `"compact"` — Компактний
  - `"normal"` — Нормальний  
  - `"spacious"` — Просторий
- **Ефект**: Контролює відступи між елементами та довжину міток полів:

| Параметр | Compact | Normal | Spacious |
|----------|---------|---------|----------|
| `grid_margin` | 10px | 20px | 30px |
| `row_grid_spacing` | 3px | 10px | 15px |
| `grid_column_spacing` | 6px | 10px | 15px |
| `frame_padding` | 5px | 10px | 15px |
| `label_mode` | `"short"` | `"middle"` | `"long"` |

### Стиль заголовків табів
- **Параметр**: `form.tab_density`
- **Тип**: перелік
- **Значення за замовчуванням**: `"normal"`
- **Можливі значення**:
  - `"compact"` — Компактний
  - `"normal"` — Нормальний
  - `"spacious"` — Просторий
- **Ефект**: Визначає довжину заголовків табів (вкладок):
  - `"compact"` → використовує `titles.short`
  - `"normal"` → використовує `titles.middle`
  - `"spacious"` → використовує `titles.long`

---

## 4. Налаштування довжини текстів

### Довжина імен осіб
- **Параметр**: `form.person_name_length`
- **Тип**: число
- **Значення за замовчуванням**: `30`
- **Діапазон**: 10–100 символів
- **Ефект**: Максимальна довжина відображення імен людей в:
  - DnD полях типу `person`
  - Підказках автокомпліту
  - Плейсхолдерах

### Довжина назв місць
- **Параметр**: `form.place_title_length`
- **Тип**: число  
- **Значення за замовчуванням**: `30`
- **Діапазон**: 10–100 символів
- **Ефект**: Максимальна довжина відображення назв місць в:
  - DnD полях типу `place`
  - Підказках автокомпліту
  - Плейсхолдерах

### Довжина тексту цитат
- **Параметр**: `form.citation_text_length`
- **Тип**: число
- **Значення за замовчуванням**: `30`
- **Діапазон**: 10–100 символів
- **Ефект**: Максимальна довжина відображення тексту цитат в:
  - DnD полях типу `citation`
  - Підказках автокомпліту
  - Плейсхолдерах

---

## 5. Налаштування поведінки вікон

### Режим вікна
- **Параметр**: `form.window_mode`
- **Тип**: перелік
- **Значення за замовчуванням**: `"transient"`
- **Можливі значення**:
  - `"detached"` — Незалежне (окремо від Gramps)
    - Вікно повністю незалежне від головного вікна Gramps
    - Може бути приховане за іншими додатками
    - `set_transient_for(None)`
    - `set_destroy_with_parent(False)`
  - `"transient"` — Прив'язане до Gramps
    - Вікно залишається поверх головного вікна Gramps
    - Закривається разом з батьківським вікном
    - `set_transient_for(parent_window)`
    - `set_destroy_with_parent(True)`
  - `"modal"` — Модальне (блокує Gramps)
    - Вікно блокує взаємодію з головним вікном Gramps
    - Користувач повинен закрити форму перед роботою з Gramps
    - `set_modal(True)`
    - `set_transient_for(parent_window)`
- **Ефект**: Змінює поведінку вікон форм відносно головного вікна Gramps через GTK методи.

### Завжди поверх інших вікон
- **Параметр**: `form.window_keep_above`
- **Тип**: логічний
- **Значення за замовчуванням**: `False`
- **Можливі значення**:
  - `True` — Тримати вікно форми поверх всіх інших вікон
  - `False` — Звичайна поведінка вікна
- **Ефект**: Викликає `set_keep_above(True/False)` для кожної форми, що змушує операційну систему тримати вікно завжди поверх інших.

---

## 6. Взаємодія налаштувань

### Автоматична синхронізація
1. **Щільність → Режим міток**: При зміні `form.density` автоматично оновлюється `label_mode`:
   ```python
   def sync_label_mode_from_density():
       density = get_settings_manager().get_form_density()
       if density == "compact": set_label_mode("short")
       elif density == "normal": set_label_mode("middle") 
       elif density == "spacious": set_label_mode("long")
   ```

2. **Щільність табів → Заголовки табів**: При зміні `form.tab_density` оновлюються заголовки всіх відкритих вкладок.

### Застосування змін
Після натискання кнопки "Зберегти" в налаштуваннях:

1. **Оновлення синхронізації**:
   ```python
   sync_label_mode_from_density()  # Оновлює режим міток
   sync_tab_mode_from_density()    # Оновлює режим табів
   ```

2. **Оновлення відкритих форм**:
   ```python
   def _refresh_open_forms(self):
       get_settings_manager.cache_clear()  # Очистка кешу
       for win in Gtk.Window.list_toplevels():
           if isinstance(win, BaseEditForm):
               win._apply_window_behavior()    # Застосування поведінки вікна
               win._on_refresh_options(None)   # Перезавантаження форми
   ```

---

## 7. Технічні деталі

### Кешування
- `SettingsManager` використовує `@lru_cache(maxsize=1)` для оптимізації
- Кеш очищується при зміні налаштувань через `get_settings_manager.cache_clear()`

### Файли конфігурації
- **Розташування**: `~/.gramps/gramps60/UARecords/configs/`
- **Файли**: 
  - `config.ini` — основний конфігураційний файл
  - `config` — внутрішній формат Gramps ConfigManager

### Обробка помилок
- Усі налаштування мають значення за замовчуванням
- При неправильних значеннях використовується fallback
- Помилки при застосуванні налаштувань ігноруються через `try/except`

---

## 8. Приклади використання

### Компактний режим для маленьких екранів
```
Стиль форм: Компактний
Колонки народження/смерті/шлюбу: 2
Довжина імен: 20
Довжина місць: 15  
Довжина цитат: 15
```

### Просторий режим для великих екранів
```
Стиль форм: Просторий
Колонки народження/смерті/шлюбу: 4-5
Довжина імен: 50
Довжина місць: 40
Довжина цитат: 40
```

### Модальний режим для фокусованої роботи
```
Режим вікна: Модальне
Завжди поверх: True
```

---

## 9. Відомі обмеження

1. **Безпека**: API ключі зберігаються в незашифрованому вигляді
2. **Кешування**: Зміни налаштувань потребують очистки кешу для негайного застосування
3. **Сумісність**: Деякі комбінації налаштувань можуть призводити до субоптимального відображення на дуже маленьких екранах
4. **Модальний режим**: При використанні модального режиму користувач може "застрягнути" якщо форма не закривається коректно

---

## 10. Налагодження

### Перевірка поточних налаштувань
```python
from settings.settings_manager import get_settings_manager
sm = get_settings_manager()
print(f"Density: {sm.get_form_density()}")
print(f"Window mode: {sm.get_window_mode()}")
print(f"AI provider: {sm.get_ai_provider()}")
```
